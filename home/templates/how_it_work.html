{% extends 'base.html' %}

{% block title %}Virtual Try-On - Dimension Studio{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    :root {
        --primary-blue: #1a73e8;
        --light-gray-bg: #f8f9fa;
        --border-color: #dee2e6;
        --text-color-dark: #212529;
        --text-color-light: #6c757d;
        --cream-bg: #fdfae6;
        --white-bg: #ffffff;
        --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        --transition: all 0.3s ease;
    }

    .virtual-tryon-page {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--light-gray-bg);
        color: var(--text-color-dark);
        line-height: 1.6;
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }

    .page-title {
        text-align: center;
        margin: 1.5rem 0;
        font-size: 2.2rem;
        color: var(--text-color-dark);
        font-weight: 700;
    }

    .page-subtitle {
        text-align: center;
        margin-bottom: 2rem;
        color: var(--text-color-light);
        max-width: 700px;
        margin-left: auto;
        margin-right: auto;
    }

    .steps-container {
        display: flex;
        flex-wrap: wrap;
        gap: 30px;
        justify-content: center;
        margin-bottom: 30px;
    }

    .step-column {
        background-color: var(--white-bg);
        border-radius: 12px;
        box-shadow: var(--card-shadow);
        padding: 25px;
        flex: 1;
        min-width: 320px;
        max-width: 420px;
        transition: var(--transition);
        display: flex;
        flex-direction: column;
    }

    .step-column:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
    }

    .step-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border-color);
    }

    .step-number {
        background-color: var(--primary-blue);
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.1rem;
    }

    .step-title {
        font-size: 1.4rem;
        font-weight: 600;
        color: var(--text-color-dark);
    }

    .info-icon {
        color: var(--text-color-light);
        cursor: help;
        margin-left: auto;
        font-size: 1.1rem;
    }

    .selected-image-review {
        margin-bottom: 25px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        height: 300px;
        overflow: hidden;
        background-color: var(--white-bg);
    }

    .selected-image-review img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    .examples-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 15px 0;
        color: var(--text-color-dark);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .examples-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
    }

    .example-image-wrapper {
        width: 100%;
        aspect-ratio: 1/1;
        border-radius: 8px;
        overflow: hidden;
        border: 2px solid transparent;
        cursor: pointer;
        transition: var(--transition);
        position: relative;
        background-color: var(--light-gray-bg);
        pointer-events: none;
    }

    .example-image-wrapper img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    .example-image-wrapper:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .example-image-wrapper.selected {
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
    }

    .result-box {
        background-color: var(--white-bg);
        border-radius: 8px;
        height: 300px;
        display: flex;
        justify-content: center;
        align-items: center;
        color: var(--text-color-light);
        font-size: 0.95em;
        margin-bottom: 25px;
        border: 1px solid var(--border-color);
        overflow: hidden;
    }

.result-box img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
}

    .result-controls {
        background-color: var(--white-bg);
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: var(--card-shadow);
    }

    .run-button {
        background-color: var(--primary-blue);
        color: var(--white-bg);
        padding: 14px 28px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.1rem;
        font-weight: 600;
        transition: var(--transition);
        width: 100%;
        margin-top: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        pointer-events: none;
    }

    .run-button:hover {
        background-color: #1664c0;
        transform: translateY(-2px);
    }

    .run-button:active {
        transform: translateY(1px);
    }

    @media (max-width: 768px) {
        .steps-container {
            flex-direction: column;
            align-items: center;
        }
        
        .step-column {
            width: 100%;
            max-width: 500px;
        }
    }

    /* Animation cursor */
    #demo-cursor {
        position: fixed;
        width: 40px;
        height: 40px;
        z-index: 9999;
        pointer-events: none;
        transition: transform 0.2s, top 1s ease, left 1s ease;
        transform: translate(-50%, -50%);
        transition-timing-function: cubic-bezier(0.175, 0.885, 0.32, 1.275);
        display: none;
    }
    
    #demo-cursor .hand {
        font-size: 32px;
        color: var(--primary-blue);
        filter: drop-shadow(0 0 4px rgba(0,0,0,0.3));
        transition: transform 0.2s;
    }
    
    #demo-cursor .click-effect {
        position: absolute;
        width: 20px;
        height: 20px;
        border: 2px solid var(--primary-blue);
        border-radius: 50%;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0);
        opacity: 0;
    }
    
    #demo-cursor.clicking .hand {
        transform: scale(0.8);
    }
    
    #demo-cursor.clicking .click-effect {
        animation: clickAnimation 0.6s ease-out;
    }
    
    @keyframes clickAnimation {
        0% {
            transform: translate(-50%, -50%) scale(0);
            opacity: 1;
        }
        100% {
            transform: translate(-50%, -50%) scale(2);
            opacity: 0;
        }
    }
    
    /* Loading spinner */
    .spinner {
        display: inline-block;
        width: 24px;
        height: 24px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
        margin-right: 10px;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>

<div class="virtual-tryon-page">
    <h1 class="page-title">Virtual Try-On Experience</h1>
    <p class="page-subtitle">Select photos of people and outfits to see how they look together. Our AI technology generates realistic fitting images in seconds.</p>
    
    <div class="steps-container">
        <!-- Step 1 -->
        <div class="step-column">
            <div class="step-header">
                <div class="step-number">1</div>
                <h3 class="step-title">Select a photo of a person</h3>
                <i class="fas fa-info-circle info-icon" title="Photos should show a person standing straight, with clear face and full body"></i>
            </div>
            
            <div class="selected-image-review" id="person-review">
                <img src="" alt="Selected person image" id="person-review-image">
            </div>
            
            <h4 class="examples-title"><i class="fas fa-images"></i> Example photo</h4>
            <div class="examples-grid" id="person-examples">
                <div class="example-image-wrapper" data-set="1">
                    <img src="/media/demo/1-1.jpg" alt="Person image set 1">
                </div>
                <div class="example-image-wrapper" data-set="2">
                    <img src="/media/demo/2-1.jpg" alt="Person image set 2">
                </div>
                <div class="example-image-wrapper"><img src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=200&q=80" alt="Person example image 3"></div>
                <div class="example-image-wrapper"><img src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=200&q=80" alt="Person example image 4"></div>
                <div class="example-image-wrapper"><img src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=200&q=80" alt="Person example image 5"></div>
                <div class="example-image-wrapper"><img src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=200&q=80" alt="Person example image 6"></div>
            </div>
        </div>
        
        <!-- Step 2 -->
        <div class="step-column">
            <div class="step-header">
                <div class="step-number">2</div>
                <h3 class="step-title">Choose a photo of the outfit</h3>
                <i class="fas fa-info-circle info-icon" title="Outfit photos should be taken on white background and be clear"></i>
            </div>
            
            <div class="selected-image-review" id="garment-review">
                <img src="" alt="Selected outfit image" id="garment-review-image">
            </div>
            
            <h4 class="examples-title"><i class="fas fa-images"></i> Example photo</h4>
            <div class="examples-grid" id="garment-examples">
                <div class="example-image-wrapper" data-set="1">
                    <img src="/media/demo/1-2.jpg" alt="Shirt image set 1">
                </div>
                <div class="example-image-wrapper" data-set="2">
                    <img src="/media/demo/2-2.jpg" alt="Shirt image set 2">
                </div>
                <div class="example-image-wrapper"><img src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=200&q=80" alt="Outfit example image 3"></div>
                <div class="example-image-wrapper"><img src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=200&q=80" alt="Outfit example image 4"></div>
                <div class="example-image-wrapper"><img src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=200&q=80" alt="Outfit example image 5"></div>
                <div class="example-image-wrapper"><img src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=200&q=80" alt="Outfit example image 6"></div>
            </div>
        </div>
        
        <!-- Step 3 -->
        <div class="step-column">
            <div class="step-header">
                <div class="step-number">3</div>
                <h3 class="step-title">View fitting results</h3>
                <i class="fas fa-info-circle info-icon" title="Results will be generated by AI technology in a few seconds"></i>
            </div>
            
            <div class="result-box" id="result-display">
                <div class="result-placeholder">
                    <i class="fas fa-tshirt" style="font-size: 5rem; color: #e0e0e0;"></i>
                    <p style="margin-top: 20px; font-size: 1.1rem;">The fitting results will be displayed here.</p>
                </div>
            </div>
            
                
                <button class="run-button" id="run-button">
                    <i class="fas fa-play-circle"></i> Try On
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Animated cursor for demo -->
<div id="demo-cursor">
    <div class="hand"><i class="fas fa-hand-pointer"></i></div>
    <div class="click-effect"></div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Demo variables
        let isDemoRunning = true;
        let currentSet = 1;
        const demoCursor = document.getElementById('demo-cursor');
        
        // Get elements for demo actions
        const personSet1 = document.querySelector('#person-examples .example-image-wrapper[data-set="1"]');
        const personSet2 = document.querySelector('#person-examples .example-image-wrapper[data-set="2"]');
        const garmentSet1 = document.querySelector('#garment-examples .example-image-wrapper[data-set="1"]');
        const garmentSet2 = document.querySelector('#garment-examples .example-image-wrapper[data-set="2"]');
        const runButton = document.getElementById('run-button');
        const resultDisplay = document.getElementById('result-display');

        // Function to programmatically select an image
        function selectImage(element) {
            // Deselect all images in the same grid
            const grid = element.closest('.examples-grid');
            grid.querySelectorAll('.example-image-wrapper').forEach(img => {
                img.classList.remove('selected');
            });
            
            // Select the target element
            element.classList.add('selected');
            
            // Update the review image
            const reviewId = grid.id.replace('-examples', '-review-image');
            const reviewImg = document.getElementById(reviewId);
            if (reviewImg) {
                const imgSrc = element.querySelector('img').src;
                reviewImg.src = imgSrc;
                reviewImg.style.display = 'block';
            }
        }

        // Function to simulate click with animation
        function simulateClick(element) {
            return new Promise((resolve) => {
                // Move cursor to element
                const rect = element.getBoundingClientRect();
                const x = rect.left + rect.width / 2;
                const y = rect.top + rect.height / 2;
                
                demoCursor.style.left = `${x}px`;
                demoCursor.style.top = `${y}px`;
                demoCursor.style.display = 'block';
                
                // Add clicking animation
                setTimeout(() => {
                    demoCursor.classList.add('clicking');
                    
                    // Programmatically select the image
                    setTimeout(() => {
                        selectImage(element);
                        
                        // Remove clicking animation
                        setTimeout(() => {
                            demoCursor.classList.remove('clicking');
                            resolve();
                        }, 300);
                    }, 300);
                }, 1000);
            });
        }

// Function to generate and display result
function generateResult(set) {
    return new Promise((resolve) => {
        // Show loading state in result box
        const resultPlaceholder = document.createElement('div');
        resultPlaceholder.className = 'result-placeholder';
        resultPlaceholder.style.cssText = 'display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;';
        resultPlaceholder.innerHTML = '<span class="spinner"></span><p style="margin-top:10px;">Generating result...</p>';
        
        resultDisplay.innerHTML = ''; // Clear previous content
        resultDisplay.appendChild(resultPlaceholder); // Append the loading state

        // Determine result image path based on set
        let resultImgSrc;
        if (set === 1) {
            resultImgSrc = "/media/demo/1-3.jpg";
        } else if (set === 2) {
            resultImgSrc = "/media/demo/2-3.jpg";
        } else {
            resultImgSrc = "default-output.jpg";
        }

        // Simulate processing delay
        setTimeout(() => {
            const img = document.createElement('img');
            img.src = resultImgSrc;
            img.alt = "Fitting result";
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'cover';
            
            img.onload = function() {
                resultDisplay.innerHTML = ''; // Clear the loading state
                resultDisplay.appendChild(img); // Append the new image
                resolve();
            };

            img.onerror = function() {
                resultDisplay.innerHTML = '<div class="result-placeholder" style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;"><i class="fas fa-exclamation-triangle" style="font-size:3rem;color:#ff6b6b;"></i><p style="margin-top:15px;">Could not load result image</p></div>';
                resolve();
            };
        }, 2000); // Increase wait time to 2 seconds to see the effect clearly
    });
}

// Function to run the demo for a specific set
async function runDemoForSet(set) {
    if (!isDemoRunning) return;
    
    currentSet = set;
    
    // Select person image
    const personElement = set === 1 ? personSet1 : personSet2;
    await simulateClick(personElement);
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // Select garment image
    const garmentElement = set === 1 ? garmentSet1 : garmentSet2;
    await simulateClick(garmentElement);
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // **Bước mới: Mô phỏng con trỏ chuột di chuyển và click vào nút "Chạy Thử Đồ"**
    const rect = runButton.getBoundingClientRect();
    demoCursor.style.left = `${rect.left + rect.width/2}px`;
    demoCursor.style.top = `${rect.top + rect.height/2}px`;
    demoCursor.style.display = 'block';
    
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // **Thực hiện click ảo**
    demoCursor.classList.add('clicking');
    await new Promise(resolve => setTimeout(resolve, 300));
    demoCursor.classList.remove('clicking');
    
    // **Chỉ sau khi click, mới thay đổi trạng thái nút**
    runButton.innerHTML = '<span class="spinner"></span> Đang Xử Lý...';
    runButton.disabled = true;
    
    // Generate and show result
    await generateResult(set);
    
    // **Thay đổi trạng thái nút trở lại "Chạy Thử Đồ"**
    runButton.innerHTML = '<i class="fas fa-play-circle"></i> Try On';
    runButton.disabled = false;
    
    // Wait before next set
    await new Promise(resolve => setTimeout(resolve, 5000));
}

        // Function to run the demo cycle
        async function runDemoCycle() {
            while (isDemoRunning) {
                await runDemoForSet(1);
                if (!isDemoRunning) break;
                await runDemoForSet(2);
                if (!isDemoRunning) break;
            }
        }

        // Initialize demo
        function initDemo() {
            // Hide cursor initially
            demoCursor.style.display = 'none';
            
            // Make sure the example images exist
            if (personSet1 && personSet2 && garmentSet1 && garmentSet2 && runButton && resultDisplay) {
                // Start demo after short delay
                setTimeout(() => {
                    runDemoCycle();
                }, 1000);
            } else {
                console.error("Could not find all required elements for demo");
            }
        }

        // Start the demo
        initDemo();
    });
</script>
{% endblock %}